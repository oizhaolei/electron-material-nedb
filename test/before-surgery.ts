(({ models, filter, log, callback }) => {
  (async () => {
    log.info('vm start.', filter);
    const columns = [
'ID',
'氏名',
'性別',
'年齢',
'生年月日',
'手術日',
'麻酔法',
'術前診断',
'手術診断',
'原発',
'術式',
'Lap or 開腹',
'個数',
'部位',
'異時、同時切除',
'異時、同時発症',
'病理',
'鏡視下',
'術者',
'第一助手',
'採取日',
'脂肪円柱',
'脂肪酸４分画',
'清濁',
'項目名称',
'分換算値',
'上皮円柱',
'不規則抗体',
'不規則抗体同定検査1',
'小球性赤血球',
'外注蓄尿量',
'生化学ｺﾒﾝﾄ1',
'生化泳動ｺﾒﾝﾄ',
'感染症ｺﾒﾝﾄ',
'無機ﾘﾝ',
'ＡＦＰ濃度',
'判定',
'ＦＴ３',
'ＦＴ４',
'大小不同',
'大球性赤血球',
'(中止)ZTT',
'(中止)ﾍﾊﾟﾃｽﾄ',
'(旧)PIVKA-Ⅱ:TM',
'中性脂肪',
'中皮細胞',
'細胞数',
'細胞種',
'細胞質内封入体',
'細菌',
'1ｶﾀ',
'24H CCr値',
'2ｶﾀ',
'3ｶﾀ',
'3ｾﾞｯﾀｲ',
'ＴＳＨ',
'4ｶﾀ',
'4ｾﾞｯﾀｲ',
'5ｶﾀ',
'6ｶﾀ',
'核膜型',
'輸血検査者',
'8ｾﾞｯﾀｲ',
'尿Na・K・Cl',
'尿素窒素',
'尿細管上皮',
'尿路上皮',
'尿酸',
'尿酸塩',
'血中ｱﾝﾓﾆｱ',
'血型ｳﾗ担当',
'血小板数',
'血沈1h',
'血液ガス酸塩基平衡検',
'血液像',
'血液型コメント',
'血液型ｵﾓﾃ担当',
'血清Fe',
'血清クレアチニン',
'血清蛋白',
'血清蛋白分画',
'血清補体価(CH50)',
'血算',
'血糖',
'血糖(ﾌｯｶ)',
'血糖（23:00）',
'血糖（夕前）',
'血糖（夕後）',
'血糖（昼前）',
'血糖（昼後）',
'血糖（朝前）',
'血糖（朝後）',
'A-CI',
'A-Ly',
'A/G',
'ABO式血液型',
'ACRｹﾂｺﾞｳ',
'ACTH',
'AFP',
'AFPﾚｸﾁﾝ分画',
'AL-1%',
'AL-2%',
'ALB',
'ALB%',
'ALP',
'ALP1',
'ALP2+ALP3',
'ALP3+ALP4',
'ALPｱｲｿ',
'ALPｱｲｿｻﾞｲﾑ',
'ALT(GPT)',
'AMY-P型',
'AMY-S型',
'AMYｱｲｿｻﾞｲﾑ',
'ANA:FAT',
'APLｶｯｾｲ',
'APTT(対照)',
'APTT(秒)',
'ASLO',
'AST(GOT)',
'Alb分画',
'AnGap',
'扁平上皮',
'Aﾊﾝﾃ',
'B-Dｸﾞﾙｶﾝ',
'B2MG･U',
'BAND',
'BCAA',
'BE(vt)',
'BETA%',
'BNP',
'BP',
'BRAF判定',
'BTR',
'Band',
'Baso',
'Blast',
'C-ｲﾝﾃﾞｯｸｽ',
'C3',
'C4',
'CA125',
'CA19-9',
'CA72-4',
'CBCｺﾒﾝﾄ1',
'CBCｺﾒﾝﾄ2',
'CD3',
'CD3ﾖｳｾ',
'CD4',
'CD4/8ﾋ',
'CD4ﾖｳｾ',
'CD8',
'CD8ﾖｳｾ',
'CEA',
'CHE',
'CK MB型',
'CK MM型',
'CKｱｲｿｻﾞｲﾑ',
'COHb',
'CPR',
'CPR･ﾁｸU',
'CRE',
'CRP',
'Ca++',
'Centromere型',
'Cl-',
'D-ﾀﾞｲﾏｰ定量',
'DUPAN-2',
'Del(ex19)',
'Diffｺﾒﾝﾄ1',
'Diffｺﾒﾝﾄ2',
'Diffｺﾒﾝﾄ3',
'Diffｺﾒﾝﾄ4',
'組織球(%)',
'E2',
'EBL',
'EGFR(未染ｽﾗｲﾄﾞ）',
'EGFRｺﾊﾞｽＶ2',
'EPA/AA比',
'EPO:RIA',
'Eos',
'幅広円柱',
'E抗原',
'ｅＧＦＲ',
'FDP(血中）',
'FIO2',
'FSH',
'Fibrinogen定量',
'顆粒円柱',
'G-CI',
'G719X',
'GADｺｳﾀｲ',
'GAMA%',
'GH',
'GTT  30分血糖',
'GTT  60分尿糖',
'GTT  60分血糖',
'GTT  前  尿糖',
'GTT 120分尿糖',
'GTT 120分血糖',
'GTT 前血糖',
'Glu',
'Granular型',
'Gﾊﾝﾃ',
'HANP',
'HBV-DNA定量（TMPCR)',
'HBc抗体',
'HBe抗体',
'HBe抗原',
'HBs抗体',
'HBs抗原',
'HCO3act',
'HCV抗体',
'HDL',
'HIV-1RNA定量（TMPCR)',
'HIV抗体',
'HS-PSA',
'HTLV1:PA',
'HbA1c(JDS)',
'HbA1c(NGSP)',
'Homogeneous型',
'HﾋﾟﾛﾘG-J',
'ICG',
'ICG 10分停滞率',
'ICG 15分停滞率',
'ICG 5分停滞率',
'ICG(停滞率）',
'ICG-10分',
'ICG-15分(停滞率）',
'ICG-30分',
'ICG-5分',
'ICG-前',
'ICG-消失率',
'ICG15分',
'ICG消失率',
'IGF-Ⅰ (ｿﾏﾄﾒｼﾞﾝC)',
'ISE',
'IgA',
'IgG',
'IgM',
'Ins(ex20)',
'IntactP1NP',
'K+',
'K-RAS(117)',
'K-RAS(12)',
'K-RAS(13)',
'K-RAS(146)',
'K-RAS(59)',
'K-RAS(61)',
'KL-6',
'KRAS117',
'KRAS12',
'KRAS13',
'KRAS146',
'KRAS59',
'KRAS61',
'L1分画',
'L3分画',
'L858R',
'L861Q',
'LAP',
'LD',
'LDH1',
'LDH2',
'LDH3',
'LDH4',
'LDH5',
'LDHｱｲｿｻﾞｲﾑ',
'LDL',
'LDL/HDL比',
'LD比',
'LH',
'Lymp',
'MAC:PCR',
'MCH',
'MCHC',
'MCV',
'MPO-ANCA',
'MetHb',
'Meta',
'Mono',
'Myel',
'免疫ｺﾒﾝﾄ',
'N-RAS(117)',
'N-RAS(12)',
'N-RAS(13)',
'N-RAS(146)',
'N-RAS(59)',
'N-RAS(61)',
'NAG',
'NRAS117',
'NRAS12',
'NRAS13',
'NRAS146',
'NRAS59',
'NRAS61',
'NSE (神経特異ｴﾉﾗ-ｾﾞ)',
'Na+',
'Neut',
'Nucleolar型',
'低色素性',
'低ｶﾙﾎﾞｷｼﾙ化OC',
'O2(CT)',
'O2SAT',
'Oth1',
'Oth2',
'Oth3',
'PCO2',
'PD-L1(22C3)未染ｽﾗｲﾄﾞ',
'PFDﾃｽﾄ',
'PFDﾃｽﾄｺﾞ',
'PH',
'PIVK-Ⅱ:TM',
'PIVKｼｭﾖｳ',
'PLGｶｯｾｲ',
'PO2',
'PR3-ANCA',
'PRL･S',
'PROGRP',
'PSA',
'PSAﾀﾝﾃﾞﾑ',
'PT%',
'PT(INR)',
'PT(対照)',
'PT(秒)',
'PTH-IN･P',
'Periphera型',
'Pro',
'ProGRP',
'結合率',
'結果',
'結果(IU表記)',
'結核菌TMPCR(喀痰)',
'RA',
'RAS(判定)',
'RAS-BRAF',
'RAS遺伝子変異解析',
'RDW-CV',
'RDW-SD',
'ROS1ｽﾗｲﾄﾞ',
'RPR',
'Rf',
'RhD式血液型',
'Rivalta反応',
'S-IL2R',
'S768I',
'SCCｺｳｹﾞﾝ',
'SLX',
'SP-D',
'SPAN-1',
'Seg',
'Speckled型',
'体温',
'体重',
'T&S適合判定',
'T-SPOTTBIFγ遊離試験',
'T-SPOT判定結果',
'T790M',
'TAT',
'TB:PCR',
'TP',
'TPA',
'TPOｺｳﾀｲ',
'TP抗体',
'TR-ABﾘｮｳ(ｺｽﾐｯｸ)',
'TR-ABﾘｮｳ(ﾛｼｭ)',
'TRACP-5b',
'U-ALB･ﾌﾞ',
'UBIT（⊿‰）',
'UBIT（判定）',
'UGT1A1遺伝子多型',
'UGT1A1遺伝子多型解析',
'UGT1A1＊28',
'UGT1A1＊6',
'UIBC',
'VZ:CF',
'WBC',
'ZTT',
'潜血',
'その他',
'硝子円柱',
'赤血球',
'赤血球数',
'fast α1',
'fast γ',
'k-ras遺伝子ｽﾗｲﾄﾞ',
'異型細胞',
'ｱｴﾝ',
'ｱｽﾍﾟﾙAG',
'ｱﾋﾞｳﾑ',
'ｱﾐﾉ/ﾁﾛｼﾝ',
'ｱﾐﾗｰｾﾞ',
'ｱﾗｷﾄﾞﾝ酸',
'ｱﾙﾄﾞ･P',
'ｱﾙﾌﾞﾐﾝ',
'ｱﾙﾐﾆｳﾑ',
'ｱﾝﾁﾄﾛﾝﾋﾞﾝⅢ',
'色調',
'ｲﾝｽﾘﾝ抗体（ﾔﾏｻ）',
'ｲﾝﾄﾗ',
'ｲﾝﾌﾙｴﾝｻﾞ',
'乳び(血清)',
'乳酸脱水素酵素',
'tCO2',
'tHb',
'totalP1NP',
'ｴｲｺｻﾍﾟﾝﾀｴﾝ酸',
'ｴﾘｽﾛﾎﾟｴﾁﾝ',
'ｴﾝﾄﾞ:ES',
'卵円形脂肪体',
'ｶﾀ',
'ｶﾘｳﾑ',
'ｶﾙｼｳﾑ',
'ｶﾝｻﾝ',
'ｶﾝｼﾞﾀﾞAG',
'ｷｼｬｸ',
'浸透圧・尿',
'浸透圧・血清',
'ｸﾗﾐIGA&G',
'ｸﾗﾐｼﾞｱIgM判定',
'ｸﾗﾐｼﾞｱIgMｲﾝﾃﾞｯｸｽ',
'ｸﾗﾐｼﾞｱﾆｭｰﾓﾆｴIgM',
'ｸﾘﾌﾟﾄｺｯｶｽﾈｵ',
'ｸﾚｱﾁﾆﾝ',
'ｸﾚｱﾁﾝｷﾅｰｾﾞ',
'ｸﾛｰﾙ',
'ｸﾞﾙｺｰｽ',
'腹水ＡＭＹ',
'ｹｯｾｲCU',
'ｹｯｾｲﾎﾀｲｶ',
'遺伝子型',
'空胞変性円柱',
'ｺﾒﾝﾄ',
'ｺﾙﾁｿﾞ-ﾙ（血漿）',
'ｻｲﾛGLB',
'ｼｭｳ酸Ca結晶',
'ｼﾌﾗ',
'ｼﾞﾎﾓ-γ-ﾘﾉﾚﾝ酸',
'好中球(%)',
'白血球',
'白血球数',
'好酸球 (%)',
'穿刺液(胸水)検査',
'穿刺液(腹水)検査',
'穿刺液PH',
'穿刺液検査',
'ﾀｲﾀｰ',
'ﾀﾝﾊﾟｸF',
'ﾁﾛｼﾝ',
'ﾄﾗﾝｽﾌｪﾘﾝ',
'ﾄﾞｺｻﾍｷｻｴﾝ酸',
'ﾅﾄﾘｳﾑ',
'沈渣コメント１',
'ﾉｳﾄﾞ',
'ﾊﾝﾃｲ',
'ﾊﾞｿﾞﾌﾟﾚｼﾝ(AVP)',
'ﾊﾟﾈﾙA',
'ﾊﾟﾈﾙB',
'ﾋﾞﾀﾐﾝB1',
'ﾋﾞﾀﾐﾝB12',
'ﾋﾞﾀﾐﾝB2',
'ﾌﾟﾚｱﾙﾌﾞﾐﾝ',
'ﾌﾟﾛｶﾙｼﾄﾆﾝ',
'ﾌﾟﾛｶﾙｼﾄﾆﾝ定量',
'ﾌﾟﾛｼﾞｪｽﾃ',
'ろう様円柱',
'ﾍﾊﾟﾃｽﾄ',
'ﾍﾏﾄｸﾘｯﾄ',
'ﾍﾓｸﾞﾛﾋﾞﾝ',
'ﾎｾｲﾁ',
'随時尿定性',
'随時尿沈渣',
'ﾏｲｺ:PA',
'ﾏｸﾞﾈｼｳﾑ',
'間接クームス判定',
'間接ﾋﾞﾘﾙﾋﾞﾝ',
'ﾖｳｻﾝ',
'抗体価',
'増幅ｼｸﾞﾅﾙ検出',
'抗核抗体',
'ﾗｸﾃｰﾄ',
'抗ｻｲﾛｸﾞﾛﾌﾞﾘﾝ抗体',
'ﾘﾝ酸Ca結晶',
'ﾘﾝﾊﾟ',
'ﾘﾝﾊﾟ球(%)',
'ﾚﾆﾝｶｯｾｲ',
'亜硝酸塩',
'採血時間',
'インスリン',
'ウロビリノーゲン',
'推定食塩摂取量',
'身長',
'新型コロナ入院ｽｸﾘｰﾆﾝ',
'新型ｺﾛﾅPCR（鼻咽頭）',
'新尿蛋白CRE補正値',
'新尿－尿 Na・K・C',
'新尿－尿無機ﾘﾝ',
'新尿－尿素窒素',
'新尿－尿蛋白',
'新尿－尿ｶﾘｳﾑ',
'新尿－尿ｶﾙｼｳﾑ',
'新尿－尿ｸﾚｱﾁﾆﾝ',
'新尿－尿ｸﾛｰﾙ',
'新尿－尿ﾅﾄﾘｳﾑ',
'α1',
'α1α2',
'α1分画',
'α2',
'α2β',
'α2分画',
'ケトン体',
'β',
'β 分画',
'β2-MG(血清）',
'βγ',
'網赤血球数',
'γ',
'γ 分画',
'γ-GTP',
'溶血(血清)',
'ジゴキシン',
'肺がんALK（FISH)',
'精子',
'便潜血定性',
'濃度',
'蓄尿-尿素窒素',
'蓄尿-尿素窒素/日',
'蓄尿-ｶﾘｳﾑ',
'蓄尿-ｶﾘｳﾑ/日',
'蓄尿-ｸﾚｱﾁﾆﾝ',
'蓄尿-ｸﾚｱﾁﾆﾝ/日',
'蓄尿-ｸﾛｰﾙ',
'蓄尿-ｸﾛｰﾙ/日',
'蓄尿-ﾅﾄﾘｳﾑ',
'蓄尿-ﾅﾄﾘｳﾑ/日',
'蓄尿蛋白CRE補正値',
'蓄尿量',
'蓄尿－尿糖',
'蓄尿－尿糖/日',
'蓄尿－尿蛋白',
'蓄尿－尿蛋白/日',
'迅速-BNP',
'迅速血中ケトン体',
'トロポニンＴ',
'蛋白',
'蛋白比',
'総胆汁酸',
'総鉄結合能',
'総ｺﾚｽﾃﾛｰﾙ',
'総ﾋﾞﾘﾙﾋﾞﾝ',
'バルプロ酸',
'ビリルビン',
'比重',
'フェリチン',
'動脈硬化指数',
'糖',
'他 分画',
'凝固コメント',
'リン酸塩',
'自己血不規則抗体',
'直接クームステスト',
'直接ﾋﾞﾘﾙﾋﾞﾝ',
'出血時間',
    ];
    try {
      const criteria = filter['患者番号'] ? {
        'ID': filter['患者番号'],
      } : {};
      const surgeries = await models['surgeries'].find(criteria).lean();
      const surgery =  await Promise.all(surgeries.map(async (s) => {
        // log.info('s:', s);
        const prevChecks = await models['checks'].distinct('採取日', {
          '患者番号': s['ID'],
          '採取日': {
            $lte: s['手術日'],
          },
        });
        log.info('prevChecks:', prevChecks);
        const sc = await Promise.all(prevChecks.map(async (pc) => {
          let checks = await models['checks'].find({
            '患者番号': s['ID'],
            '採取日': pc,
          }).lean();
          checks = checks.reduce((r, v) => {
            r[v['項目名称']] = v['検査結果値'];
            log.info('v:', v);
            return r;
          }, {});
          return {
            ...s,
            '採取日': pc,
            ...checks,
          };
        }));
        // log.info('sc:', sc);
        return sc;
      }));
      callback(false, {
        surgery: {
          data: surgery.flat(),
          columns,
        },
      });
    } catch (e) {
      log.info('e:', e);
      callback(e);
    }
    log.info('vm end');
  })();
};
